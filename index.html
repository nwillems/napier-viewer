<!DOCTYPE html>
<html>
<head>
    <title>LogViewer for bunyan JSON</title>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<style type="text/css">
#logtable-container {
    padding: 0 20px;
}
</style>
</head>
<body>
<div id="container-fluid">
<div class="row-fluid"><div class="span12">&nbsp;</div></div>
<div class="row-fluid"><div class="span10 offset1">
<form id="fileform">
    <div class="input-append">
        <input class="span11" id="logfile" size="16" type="text" placeholder="HTTP link to file" />
        <button type="button" class="btn" id="logview">View log</button>
    </div>
</form>
</div></div>
<div class="row-fluid">
<div class="span12" id="logtable-container">
<table id="logtable" class="table table-bordered"><thead>
    <tr>
        <th>_</th>
        <th>Time</th>
        <th>Name</th>
        <th>PID</th>
        <th>Component</th>
        <!-- <th>Hostname</th> -->
        <th>Level</th>
        <th>Message</th>
    </tr>
</thead><tbody>
    <tr>
        <!-- <td>Time</td>
        <td>Name</td>
        <td>PID</td>
        <td>Component</td>
        <td>Hostname</td>
        <td>Level</td>
        <td>Message</td>  -->
        <td colspan="7">Please paste a link</td>
    </tr>
</tbody></table>
</div></div>
</div>

<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script>
var objs = [];
var shownItems = 0;

function loadFile(){
    $.ajax( {
        url: $('#logfile').val(),
        dataType: 'text',
        success: function(data){
            objs = processLines(data);
            shownItems = 0;
            displayData(0, 50);
        }
    });
    objs = [];
    $('#logtable > tbody').html('');
    //Make some loading logic
}
//Return array
function processLines(data){
    var lines = data.split('\n');
    var result = new Array();
    for(var i = 0; i < lines.length-1; i++){ //Last line doesn't count
        try{
            result.push(JSON.parse(lines[i]));
        }catch(err){
            console.log(err, "i", i,"line", lines[i]);
        }
    }

    return result;
}
function displayData(start, end){
    var tbody = $('#logtable > tbody');
    var i = start;
    for(; i < end && i < objs.length; i++)
            tbody.append(mkTableRow(objs[i]));

    shownItems += i;
}
//Returns jQuery tr object
function mkTableRow(obj){
    var info_row = $('<tr>');
    info_row.append('<td class="expand"><i class="icon-chevron-right"></i></td>');
    info_row.append('<td>'+obj.time+'</td>');
    info_row.append('<td>'+obj.name+'</td>');
    info_row.append('<td>'+obj.pid+'</td>');
    info_row.append('<td>'+obj.component+'</td>');
    // res.append('<td>'+obj.hostname+'</td>');
    info_row.append('<td>'+obj.level+'</td>');
    info_row.append('<td>'+obj.msg+'</td>');

    var data_row = $('<tr>');
    data_row.hide();
    var data = JSON.stringify(obj, undefined, 2);
    data_row.append('<td colspan="6"><pre class=".pre-scrollable">'+data+'</pre></td>')

    var res = [info_row, data_row];

    return res;
}

function atBottom(){
    return $(window).scrollTop() === $(document).height() -  $(window).height();
}

$(document).ready(function(){
    function load(){ loadFile(); return false; }
    $('#fileform').submit(load);
    $('#logview').click(load);

    $(window).scroll(function(){
        if(atBottom()){
            displayData(shownItems, shownItems+50);
        }
        return false;
    });

    $('#logtable > tbody').on('click', '.expand', function(event){
        var data_row = event.currentTarget.parentElement.nextSibling;
        $(data_row).toggle()
        if($(data_row).is(':visible')){
            $(event.currentTarget).attr('rowspan', '2');
        }else{
            $(event.currentTarget).removeAttr('rowspan');
        }
        return false;
    });
});
</script>
</body>
</html>
